<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.4.1: http://docutils.sourceforge.net/" />
<title>Simple HTTP server</title>
<meta name="author" content="Adrian Perez &lt;aperez&#64;igalia.com&gt;" />
<meta name="copyright" content="2008 Igalia S.L." />
<link rel="stylesheet" href="../../style.css" type="text/css" />
</head>
<body>
<div class="document" id="simple-http-server">
<h1 class="title">Simple HTTP server</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Adrian Perez &lt;<a class="reference" href="mailto:aperez&#64;igalia.com">aperez&#64;igalia.com</a>&gt;</td></tr>
<tr class="field"><th class="docinfo-name">License:</th><td class="field-body">GPL v2</td>
</tr>
<tr><th class="docinfo-name">Copyright:</th>
<td>2008 Igalia S.L.</td></tr>
</tbody>
</table>
<div class="abstract topic">
<p class="topic-title first">Abstract</p>
<p>Provides a not-so-basic standalone web server.
Socket functionality is <strong>not</strong> provided. Requests are
read from standard input, responses are sent to standard
output and logging is done the standard error stream.</p>
</div>
<div class="contents topic">
<p class="topic-title first"><a id="contents" name="contents">Contents</a></p>
<ul class="simple">
<li><a class="reference" href="#running-a-webserver" id="id3" name="id3">Running a webserver</a><ul>
<li><a class="reference" href="#using-auxiliar-tools" id="id4" name="id4">Using auxiliar tools</a></li>
</ul>
</li>
<li><a class="reference" href="#functions" id="id5" name="id5">Functions</a><ul>
<li><a class="reference" href="#http-mimetype-guess" id="id6" name="id6">http_mimetype_guess</a></li>
<li><a class="reference" href="#http-error-document" id="id7" name="id7">http_error_document</a></li>
<li><a class="reference" href="#http-header" id="id8" name="id8">http_header</a></li>
<li><a class="reference" href="#http-header-start" id="id9" name="id9">http_header_start</a></li>
<li><a class="reference" href="#http-error" id="id10" name="id10">http_error</a></li>
<li><a class="reference" href="#http-redirect" id="id11" name="id11">http_redirect</a></li>
<li><a class="reference" href="#http-log-stderr" id="id12" name="id12">http_log_stderr</a></li>
<li><a class="reference" href="#http-handle-get" id="id13" name="id13">http_handle_GET</a></li>
<li><a class="reference" href="#http-handle-request" id="id14" name="id14">http_handle_request</a></li>
</ul>
</li>
</ul>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id3" id="running-a-webserver" name="running-a-webserver">Running a webserver</a></h1>
<p>Fortunately, dealing with sockets can be done in pure Bash <a class="footnote-reference" href="#id2" id="id1" name="id1">[1]</a>.
Unfortunately enough, some distributors choose not to enable support for
this feature. This is the case of the Bash builds included with <a class="reference" href="http://debian.org">Debian</a>
and <a class="reference" href="http://ubuntulinux.org">Ubuntu</a>.</p>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1" name="id2">[1]</a></td><td><a class="reference" href="http://unixjunkie.blogspot.com/2006/01/two-cool-bash-tricks.html">http://unixjunkie.blogspot.com/2006/01/two-cool-bash-tricks.html</a></td></tr>
</tbody>
</table>
<div class="section">
<h2><a class="toc-backref" href="#id4" id="using-auxiliar-tools" name="using-auxiliar-tools">Using auxiliar tools</a></h2>
<p>Some utilities exist which allow nearly all program
using the standard input and output streams to use sockets. It is likely
that at least one of these is available for your operating system of
choice. All those examples run a simple web server listening in port
<tt class="docutils literal"><span class="pre">8000</span></tt> at <tt class="docutils literal"><span class="pre">127.0.0.1</span></tt> (the loopback network address). Once you try
one of those command lines, point a browser to <a class="reference" href="http://localhost:8000/doc">http://localhost:8000/doc</a>
and you will be able of browsing the Bill documentation using the simple
built-in web server.</p>
<table border="1" class="tabular docutils">
<colgroup>
<col width="11%" />
<col width="89%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">Package</th>
<th class="head">Command</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><a class="reference" href="http://smarden.org/ipsvd/">ipsvd</a></td>
<td><tt class="docutils literal"><span class="pre">tcpsvd</span> <span class="pre">127.0.0.1</span> <span class="pre">8000</span> <span class="pre">./scripts/bill</span> <span class="pre">lib/www/http.bsh</span></tt></td>
</tr>
<tr><td><a class="reference" href="http://cr.yp.to/ucspi-tcp.html">ucspi-tcp</a></td>
<td><tt class="docutils literal"><span class="pre">tcpserver</span> <span class="pre">-q</span> <span class="pre">127.0.0.1</span> <span class="pre">8000</span> <span class="pre">./scripts/bill</span> <span class="pre">lib/www/http.bsh</span></tt></td>
</tr>
<tr><td><a class="reference" href="http://netcat.sourceforge.net/">netcat</a></td>
<td><tt class="docutils literal"><span class="pre">(while</span> <span class="pre">true</span> <span class="pre">;</span> <span class="pre">do</span> <span class="pre">nc</span> <span class="pre">-l</span> <span class="pre">-p</span> <span class="pre">8000</span> <span class="pre">-c</span> <span class="pre">'./scripts/bill</span> <span class="pre">lib/www/http.bsh';</span> <span class="pre">done)</span></tt></td>
</tr>
<tr><td><a class="reference" href="http://web.purplefrog.com/~thoth/netpipes/netpipes.html">netpipes</a></td>
<td><tt class="docutils literal"><span class="pre">faucet</span> <span class="pre">8000</span> <span class="pre">-H</span> <span class="pre">127.0.0.1</span> <span class="pre">-i</span> <span class="pre">-o</span> <span class="pre">./scripts/bill</span> <span class="pre">lib/www/http.bsh</span></tt></td>
</tr>
</tbody>
</table>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">Commands should be run from the top-level Bill source
directory, otherwise they may not work.</p>
</div>
<div class="warning">
<p class="first admonition-title">Warning</p>
<p class="last">The <a class="reference" href="http://netcat.sourceforge.net/">netcat</a> command is very flaky, it will not accept
concurrent connections, and in general will perform poorly.</p>
</div>
</div>
</div>
<div class="section">
<h1><a class="toc-backref" href="#id5" id="functions" name="functions">Functions</a></h1>
<div class="section">
<h2><a class="toc-backref" href="#id6" id="http-mimetype-guess" name="http-mimetype-guess">http_mimetype_guess</a></h2>
<pre class="literal-block">
http_mimetype_guess path
</pre>
<p>Determines MIME types depending on the entries of a hash map named
<tt class="docutils literal"><span class="pre">http_mime_mapping</span></tt>, which contains a default set of entries which
suffice for serving the Bill documentation. The suffix of the file
pointed by <tt class="docutils literal"><span class="pre">path</span></tt> is used to determine its content type.</p>
<p>For example:</p>
<div class="highlight"><pre><span class="o">(</span>bill<span class="o">)</span> http_mimetype_guess /etc/sysctl.conf
text/plain
</pre></div>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id7" id="http-error-document" name="http-error-document">http_error_document</a></h2>
<pre class="literal-block">
http_error_document [ code [ description ... ] ]
</pre>
<p>Generates an error document in standard output:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">code</span></tt> is the HTTP error code (default is <tt class="docutils literal"><span class="pre">500</span></tt>)</li>
<li><tt class="docutils literal"><span class="pre">description</span></tt> is an arbitrary piece of text which will be inserted
pre-formatted in the output.</li>
</ul>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id8" id="http-header" name="http-header">http_header</a></h2>
<pre class="literal-block">
http_header name value
</pre>
<p>Sends an HTTP header.</p>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id9" id="http-header-start" name="http-header-start">http_header_start</a></h2>
<pre class="literal-block">
http_header_start [ code [ description ] ]
</pre>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id10" id="http-error" name="http-error">http_error</a></h2>
<pre class="literal-block">
http_error [ code [ description ... ] ]
</pre>
<p>Sends an HTTP error status code and an accompanying HTML document
explaining the error. Error document is formatted using
<a class="reference" href="#http-error-document">http_error_document</a>.</p>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id11" id="http-redirect" name="http-redirect">http_redirect</a></h2>
<pre class="literal-block">
http_redirect uri [ code ]
</pre>
<p>Sends an HTTP redirection, to the given <tt class="docutils literal"><span class="pre">uri</span></tt>. If not supplied, the
<tt class="docutils literal"><span class="pre">code</span></tt> will be <tt class="docutils literal"><span class="pre">302</span></tt> (a permanent redirect). You can pass <tt class="docutils literal"><span class="pre">301</span></tt>
for temporary redirects. Keep in mind that using absolute paths in
redirects is recommended.</p>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id12" id="http-log-stderr" name="http-log-stderr">http_log_stderr</a></h2>
<pre class="literal-block">
http_log_stderr [ arg1 [ arg2 ... [ argN ] ] ]
</pre>
<p>Logs a line of output to standard error. Log format is as follows:</p>
<pre class="literal-block">
&lt;method&gt; &lt;path&gt; HTTP/&lt;version&gt; - arg1 arg2 ... argN
</pre>
<p>Note that timestamps are not added to output. This is left as is
intentionally: it is nicer to add a filter in standard output which
does further formatting of logged text, and we do not have to mess
with date formatting.</p>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id13" id="http-handle-get" name="http-handle-get">http_handle_GET</a></h2>
<pre class="literal-block">
http_handle_GET
</pre>
<p>Default handler for the HTTP <tt class="docutils literal"><span class="pre">GET</span></tt> method. This does nothing more than
serving static files and producing directory listings. Also, if path
resolves to a directory which contains a file named <tt class="docutils literal"><span class="pre">index.html</span></tt> it
will be served instead.</p>
</div>
<div class="section">
<h2><a class="toc-backref" href="#id14" id="http-handle-request" name="http-handle-request">http_handle_request</a></h2>
<pre class="literal-block">
http_handle_request [ handler_prefix ]
</pre>
<p>Serves a single HTTP request. The following variables are set by the
function and their values <strong>will be clamped</strong> if already defined. Note
that most of them start with the <tt class="docutils literal"><span class="pre">HTTP_</span></tt> prefix or have names of the
variables used by the <a class="reference" href="http://www.w3.org/CGI/">CGI interface</a>:</p>
<ul class="simple">
<li>REQUEST_METHOD</li>
<li>PATH_INFO</li>
<li>QUERY_STRING</li>
<li>...and so on.</li>
</ul>
<p>The <tt class="docutils literal"><span class="pre">handler_prefix</span></tt> can be used to change behavior of how requests
are served. It is used to find which functions are used to serve the
different HTTP methods. As an example, one could define:</p>
<div class="highlight"><pre>my_handler_GET <span class="o">()</span> <span class="o">{</span>
    <span class="c"># Do something interesting...</span>
<span class="o">}</span>
my_handler_HEAD <span class="o">()</span> <span class="o">{</span>
    <span class="c"># ...and something *even* more interesting.</span>
<span class="o">}</span>
</pre></div>
<p>and then use <tt class="docutils literal"><span class="pre">my_handler</span></tt> as prefix, then the HTTP request hadler will
pass <tt class="docutils literal"><span class="pre">GET</span></tt> to <tt class="docutils literal"><span class="pre">my_handler_GET</span></tt> and <tt class="docutils literal"><span class="pre">HEAD</span></tt> ones to
<tt class="docutils literal"><span class="pre">my_handler_HEAD</span></tt>. This allows for easily reusing the HTTP module.</p>
</div>
</div>
</div>
</body>
</html>
