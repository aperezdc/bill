<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.5: http://docutils.sourceforge.net/" />
<title>Module for filesystem-based spools</title>
<meta name="author" content="Adrián Pérez &lt;aperez&#64;igalia.com&gt;" />
<meta name="copyright" content="2008 Igalia S.L." />
<link rel="stylesheet" href="../../style.css" type="text/css" />
</head>
<body>
<div class="document" id="module-for-filesystem-based-spools">
<h1 class="title">Module for filesystem-based spools</h1>
<table class="docinfo" frame="void" rules="none">
<col class="docinfo-name" />
<col class="docinfo-content" />
<tbody valign="top">
<tr><th class="docinfo-name">Author:</th>
<td>Adrián Pérez &lt;<a class="reference external" href="mailto:aperez&#64;igalia.com">aperez&#64;igalia.com</a>&gt;</td></tr>
<tr><th class="docinfo-name">Copyright:</th>
<td>2008 Igalia S.L.</td></tr>
<tr class="field"><th class="docinfo-name">License:</th><td class="field-body">GPL v2</td>
</tr>
</tbody>
</table>
<div class="abstract topic">
<p class="topic-title first">Abstract</p>
<p>Provides mechanism for having a directory with spooled items.
Items may be files or subdirectories which can be created, listed and
removed. All the operations are done at the filesystem level and
atomicity is guaranteed by using renames.</p>
</div>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#usage" id="id1">Usage</a><ul>
<li><a class="reference internal" href="#common-arguments" id="id2">Common arguments</a></li>
<li><a class="reference internal" href="#workflow" id="id3">Workflow</a></li>
</ul>
</li>
<li><a class="reference internal" href="#functions" id="id4">Functions</a><ul>
<li><a class="reference internal" href="#spool-make-uid" id="id5">spool_make_uid</a></li>
<li><a class="reference internal" href="#spool-mkdir" id="id6">spool_mkdir</a></li>
<li><a class="reference internal" href="#spool-touch" id="id7">spool_touch</a></li>
<li><a class="reference internal" href="#spool-state-get" id="id8">spool_state_get</a></li>
<li><a class="reference internal" href="#spool-state-set" id="id9">spool_state_set</a></li>
<li><a class="reference internal" href="#spool-commit" id="id10">spool_commit</a></li>
<li><a class="reference internal" href="#spool-zap" id="id11">spool_zap</a></li>
<li><a class="reference internal" href="#spool-items" id="id12">spool_items</a></li>
<li><a class="reference internal" href="#spool-cleanup" id="id13">spool_cleanup</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="usage">
<h1><a class="toc-backref" href="#id1">Usage</a></h1>
<div class="section" id="common-arguments">
<h2><a class="toc-backref" href="#id2">Common arguments</a></h2>
<p>Most of the functions accept either a <tt class="docutils literal"><span class="pre">spooldir</span></tt> (a spool directory)
or a <tt class="docutils literal"><span class="pre">spoolitem</span></tt> (an item inside the spool directory) argument.
A spool directory is a user-created directory, initially empty, which
will be accessed by means of the functions defined in this module;
otherwise behaviour is undefined. A spool item is the path to an item
inside the spool file (including the name of the spool directory itself
as prefix).</p>
</div>
<div class="section" id="workflow">
<h2><a class="toc-backref" href="#id3">Workflow</a></h2>
<p>There are three states in which a item inside a spool directory can be:</p>
<dl class="docutils">
<dt>Temporary</dt>
<dd>Item file names start with <tt class="docutils literal"><span class="pre">t:</span></tt>. In this state the items are
being created.</dd>
<dt>Zapping</dt>
<dd>Item file names start with <tt class="docutils literal"><span class="pre">z:</span></tt>. In this state the items are
being deleted. There is no way of accessing an item once it was
marked for deletion.</dd>
<dt>Committed</dt>
<dd>Item file names start with <tt class="docutils literal"><span class="pre">c:</span></tt>. In this state it is supposed that
the data in the item will be only read.</dd>
</dl>
<p>Created items (either via <a class="reference internal" href="#spool-mkdir">spool_mkdir</a> or <a class="reference internal" href="#spool-touch">spool_touch</a>) are initially in
a “temporary” state. Items in this state will not be listed by default
using <a class="reference internal" href="#spool-items">spool_items</a>.</p>
<p>Additional states with arbitrary names for spool items can be used.
State transitions can be manually done by using <a class="reference internal" href="#spool-state-set">spool_state_set</a>. The
only thing to care about is not using the <tt class="docutils literal"><span class="pre">t</span></tt>, <tt class="docutils literal"><span class="pre">z</span></tt> and <tt class="docutils literal"><span class="pre">c</span></tt> as
custom state names.</p>
</div>
</div>
<div class="section" id="functions">
<h1><a class="toc-backref" href="#id4">Functions</a></h1>
<div class="section" id="spool-make-uid">
<h2><a class="toc-backref" href="#id5">spool_make_uid</a></h2>
<pre class="literal-block">
spool_make_uid
</pre>
<p>Creates an unique identifier suitable to be used as temporary item in
a spool directory. If available, this function uses the <tt class="docutils literal"><span class="pre">uuidgen</span></tt>
program (included as part of <a class="reference external" href="http://e2fsprogs.sf.net">e2fsprogs</a>),
otherwise uses the Bash-supplied <tt class="docutils literal"><span class="pre">$RANDOM</span></tt> variable and the process
identifier, which is somewhat weaker, but should work reasonably well.</p>
<div class="note">
<p class="first admonition-title">Note</p>
<p class="last">It is up to the caller preprending the string with the state
of the item. This functions does <em>only</em> create a suitable name.</p>
</div>
</div>
<div class="section" id="spool-mkdir">
<h2><a class="toc-backref" href="#id6">spool_mkdir</a></h2>
<pre class="literal-block">
spool_mkdir spooldir
</pre>
<p>Creates a new temporary directory in the spool directory. Once data in
the directory was filled in <a class="reference internal" href="#spool-commit">spool_commit</a> must be applied to it
because the directory will be initially marked as temporary.</p>
</div>
<div class="section" id="spool-touch">
<h2><a class="toc-backref" href="#id7">spool_touch</a></h2>
<pre class="literal-block">
spool_touch spooldir
</pre>
<p>Creates a new file in temporary state. Once data gets added to the file
<a class="reference internal" href="#spool-commit">spool_commit</a> must be applied to it.</p>
</div>
<div class="section" id="spool-state-get">
<h2><a class="toc-backref" href="#id8">spool_state_get</a></h2>
<pre class="literal-block">
spool_state_get spoolitem
</pre>
<p>Obtains the state of a spool item. States are the fierst letters of file
names before a colon.</p>
</div>
<div class="section" id="spool-state-set">
<h2><a class="toc-backref" href="#id9">spool_state_set</a></h2>
<pre class="literal-block">
spool_state_set spoolitem state
</pre>
<p>Sets the state of an item. The state may be any letter. Note that the
implementation of the module already uses <tt class="docutils literal"><span class="pre">t</span></tt>, <tt class="docutils literal"><span class="pre">c</span></tt> and <tt class="docutils literal"><span class="pre">z</span></tt>;
remaining letters may be freely used to mark states. Prints the
resulting spool item.</p>
</div>
<div class="section" id="spool-commit">
<h2><a class="toc-backref" href="#id10">spool_commit</a></h2>
<pre class="literal-block">
spool_commit spoolitem
</pre>
<p>Commits a spool item. This makes items transition from temporary to
commited state. Prints the resulting spool item.</p>
</div>
<div class="section" id="spool-zap">
<h2><a class="toc-backref" href="#id11">spool_zap</a></h2>
<pre class="literal-block">
spool_zap spoolitem [ kind ]
</pre>
<p>Deletes one item from the spool directory.</p>
</div>
<div class="section" id="spool-items">
<h2><a class="toc-backref" href="#id12">spool_items</a></h2>
<pre class="literal-block">
spool_items spooldir [ kind ]
</pre>
<p>Enumerates items in a spool directory. Spool items are returned as paths
to the items including the spool path itself as prefix. Kind may be:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">t</span></tt> for temporary items.</li>
<li><tt class="docutils literal"><span class="pre">c</span></tt> for commited items (the default).</li>
</ul>
</div>
<div class="section" id="spool-cleanup">
<h2><a class="toc-backref" href="#id13">spool_cleanup</a></h2>
<pre class="literal-block">
spool_cleanup spooldir [ kind ]
</pre>
<p>Cleans up the spool directory. All temporary items and stray in-deletion
items will be removed. The latter takes into account the case of an
interrupted run of <a class="reference internal" href="#spool-zap">spool_zap</a>.</p>
</div>
</div>
</div>
</body>
</html>
